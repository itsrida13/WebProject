<!-- views/menu.ejs -->

<!-- Fixed Cart Icon (Top Right) -->
<div class="cart-icon-fixed">
  <a href="/cart" class="cart-link">
    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M9 2C9 1.44772 9.44772 1 10 1H14C14.5523 1 15 1.44772 15 2V4H20C20.5523 4 21 4.44772 21 5C21 5.55228 20.5523 6 20 6H19.9199L19 19C19 20.6569 17.6569 22 16 22H8C6.34315 22 5 20.6569 5 19L4.08008 6H4C3.44772 6 3 5.55228 3 5C3 4.44772 3.44772 4 4 4H9V2Z" stroke="currentColor" stroke-width="2"/>
    </svg>
    <span class="cart-count" id="cartCount">0</span>
  </a>
</div>

<div class="menu-container">
  <!-- Page Header -->
  <div class="menu-hero">
    <h1>Our Premium Services</h1>
    <p>Explore our comprehensive financial solutions tailored for your success</p>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filters-header">
      <div class="filters-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 6H20M7 12H17M10 18H14" stroke="#00bcd4" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <h3>Filter Products</h3>
      </div>
      <div class="results-count">
        <span><%= products.length %></span> of <span><%= totalProducts %></span> products
      </div>
    </div>

    <form action="/menu" method="GET" class="filters-form">
      <div class="filter-item">
        <label for="category">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
            <rect x="14" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
            <rect x="3" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
            <rect x="14" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
          </svg>
          Category
        </label>
        <select class="form-select" id="category" name="category">
          <option value="">All Categories</option>
          <% categories.forEach(cat => { %>
            <option value="<%= cat %>" <%= selectedCategory === cat ? 'selected' : '' %>>
              <%= cat %>
            </option>
          <% }) %>
        </select>
      </div>

      <div class="filter-item">
        <label for="minPrice">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M12 2V22M17 7H9.5C8.57174 7 7.6815 7.36875 7.02513 8.02513C6.36875 8.6815 6 9.57174 6 10.5C6 11.4283 6.36875 12.3185 7.02513 12.9749C7.6815 13.6313 8.57174 14 9.5 14H14.5C15.4283 14 16.3185 14.3687 16.9749 15.0251C17.6313 15.6815 18 16.5717 18 17.5C18 18.4283 17.6313 19.3185 16.9749 19.9749C16.3185 20.6313 15.4283 21 14.5 21H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Min Price (Rs.)
        </label>
        <input type="number" class="form-input" id="minPrice" name="minPrice" 
               placeholder="0" value="<%= minPrice %>">
      </div>

      <div class="filter-item">
        <label for="maxPrice">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M12 2V22M17 7H9.5C8.57174 7 7.6815 7.36875 7.02513 8.02513C6.36875 8.6815 6 9.57174 6 10.5C6 11.4283 6.36875 12.3185 7.02513 12.9749C7.6815 13.6313 8.57174 14 9.5 14H14.5C15.4283 14 16.3185 14.3687 16.9749 15.0251C17.6313 15.6815 18 16.5717 18 17.5C18 18.4283 17.6313 19.3185 16.9749 19.9749C16.3185 20.6313 15.4283 21 14.5 21H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Max Price (Rs.)
        </label>
        <input type="number" class="form-input" id="maxPrice" name="maxPrice" 
               placeholder="20000" value="<%= maxPrice %>">
      </div>

      <div class="filter-actions">
        <button type="submit" class="btn-apply">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Apply Filters
        </button>
        <a href="/menu" class="btn-reset">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M4 4L20 20M20 4L4 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Reset
        </a>
      </div>
    </form>
  </div>

  <!-- Products Grid -->
  <div class="products-wrapper">
    <% if (products.length > 0) { %>
      <div class="products-grid">
        <% products.forEach(product => { %>
          <div class="product-card" data-category="<%= product.category %>">
            <div class="product-image-container">
              <img src="<%= product.image %>" alt="<%= product.name %>" class="product-img">
              <div class="product-badge"><%= product.category %></div>
              <div class="product-overlay">
                <button class="quick-view-btn">Quick View</button>
              </div>
            </div>
            
            <div class="product-info">
              <h3 class="product-name"><%= product.name %></h3>
              <p class="product-desc"><%= product.description %></p>
              
              <div class="product-bottom">
                <div class="price-section">
                  <span class="price-label">Price</span>
                  <span class="price-amount">Rs. <%= product.price.toLocaleString() %></span>
                </div>
                
                <button class="add-cart-btn" 
                        data-id="<%= product._id %>"
                        data-name="<%= product.name %>"
                        data-price="<%= product.price %>"
                        data-image="<%= product.image %>"
                        data-description="<%= product.description %>">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M9 2C9 1.44772 9.44772 1 10 1H14C14.5523 1 15 1.44772 15 2V4H20C20.5523 4 21 4.44772 21 5C21 5.55228 20.5523 6 20 6H19.9199L19 19C19 20.6569 17.6569 22 16 22H8C6.34315 22 5 20.6569 5 19L4.08008 6H4C3.44772 6 3 5.55228 3 5C3 4.44772 3.44772 4 4 4H9V2Z" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Add to Cart
                </button>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="no-products-found">
        <svg width="100" height="100" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" stroke="#ddd" stroke-width="2"/>
          <path d="M8 15C8 15 9.5 17 12 17C14.5 17 16 15 16 15M9 9H9.01M15 9H15.01" stroke="#ddd" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <h2>No Products Found</h2>
        <p>Try adjusting your filters to see more results</p>
        <a href="/menu" class="btn-reset-large">Clear All Filters</a>
      </div>
    <% } %>
  </div>

  <!-- Pagination -->
  <% if (totalPages > 1) { %>
    <div class="pagination-section">
      <nav class="pagination">
        <a href="?page=<%= currentPage - 1 %>&category=<%= selectedCategory %>&minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>" 
           class="page-link <%= currentPage === 1 ? 'disabled' : '' %>">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Previous
        </a>

        <div class="page-numbers">
          <% for (let i = 1; i <= totalPages; i++) { %>
            <a href="?page=<%= i %>&category=<%= selectedCategory %>&minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>" 
               class="page-num <%= currentPage === i ? 'active' : '' %>">
              <%= i %>
            </a>
          <% } %>
        </div>

        <a href="?page=<%= currentPage + 1 %>&category=<%= selectedCategory %>&minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>" 
           class="page-link <%= currentPage === totalPages ? 'disabled' : '' %>">
          Next
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </a>
      </nav>

      <p class="pagination-info">Page <%= currentPage %> of <%= totalPages %></p>
    </div>
  <% } %>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
  <div class="toast-icon">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="M20 6L9 17L4 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>
  <div class="toast-content">
    <span class="toast-title">Added to Cart!</span>
    <span class="toast-message" id="toastMessage">Product has been added to your cart</span>
  </div>
</div>



<script>
// ==================== CART FUNCTIONALITY ====================
document.addEventListener('DOMContentLoaded', function() {
  // Initialize cart from localStorage
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  
  // Update cart count on page load
  updateCartCount();

  // Add to cart buttons
  const addToCartButtons = document.querySelectorAll('.add-cart-btn');
  
  addToCartButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      const productData = {
        id: this.dataset.id,
        name: this.dataset.name,
        price: parseFloat(this.dataset.price),
        image: this.dataset.image,
        description: this.dataset.description,
        quantity: 1
      };

      // Check if product already exists in cart
      const existingProductIndex = cart.findIndex(item => item.id === productData.id);
      
      if (existingProductIndex > -1) {
        // Product exists, increase quantity
        cart[existingProductIndex].quantity += 1;
        showToast(`${productData.name} quantity increased!`);
      } else {
        // New product, add to cart
        cart.push(productData);
        showToast(`${productData.name} added to cart!`);
      }

      // Save cart to localStorage
      localStorage.setItem('cart', JSON.stringify(cart));
      
      // Update cart count
      updateCartCount();
      
      // Button animation
      this.style.transform = 'scale(0.9)';
      setTimeout(() => {
        this.style.transform = 'scale(1)';
      }, 200);
    });
  });

  // Update cart count function
  function updateCartCount() {
    const cartCountElement = document.getElementById('cartCount');
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCountElement.textContent = totalItems;
    
    // Show/hide badge
    if (totalItems > 0) {
      cartCountElement.style.display = 'flex';
    } else {
      cartCountElement.style.display = 'none';
    }

    // Sync to Cookie for Server-Side access
    document.cookie = "cart=" + JSON.stringify(cart) + "; path=/; max-age=86400"; // 1 day
  }

  // Show toast notification
  function showToast(message) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  }
});
</script>